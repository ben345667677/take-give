name: Deploy to AWS (SSH)

# This workflow deploys to AWS EC2 using SSH
# Triggers ONLY after tests pass on main branch
# IMPORTANT: Deployment runs ONLY if tests succeed!

on:
  workflow_run:
    workflows: ["Run Tests"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    name: Deploy to AWS via SSH
    runs-on: ubuntu-latest
    # Only deploy if tests passed successfully
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2 via SSH
        run: |
          ssh -i ~/.ssh/deploy_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e

            echo "üöÄ Starting deployment on EC2..."

            # Check and install Docker if needed
            echo "üîç Checking Docker installation..."
            if ! command -v docker &> /dev/null; then
              echo "üì¶ Docker not found. Installing Docker..."

              # Detect OS
              if [ -f /etc/os-release ]; then
                . /etc/os-release
                OS=$ID
              fi

              if [ "$OS" = "amzn" ] || [ "$OS" = "centos" ] || [ "$OS" = "rhel" ]; then
                # Amazon Linux / CentOS / RHEL
                echo "üêß Detected Amazon Linux/RHEL-based system"
                sudo yum update -y
                sudo yum install -y docker
                sudo systemctl start docker
                sudo systemctl enable docker
                sudo usermod -aG docker $USER
              elif [ "$OS" = "ubuntu" ] || [ "$OS" = "debian" ]; then
                # Ubuntu / Debian
                echo "üêß Detected Debian-based system"
                sudo apt-get update
                sudo apt-get install -y docker.io
                sudo systemctl start docker
                sudo systemctl enable docker
                sudo usermod -aG docker $USER
              else
                echo "‚ùå Unsupported OS. Please install Docker manually."
                exit 1
              fi

              echo "‚úÖ Docker installed successfully"
              # Refresh group membership for current session
              newgrp docker || true
            else
              echo "‚úÖ Docker is already installed"
            fi

            # Check and install docker-compose if needed
            echo "üîç Checking docker-compose installation..."
            if ! command -v docker-compose &> /dev/null; then
              echo "üì¶ docker-compose not found. Installing..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose

              # Verify installation
              if command -v docker-compose &> /dev/null; then
                echo "‚úÖ docker-compose installed successfully: $(docker-compose --version)"
              else
                echo "‚ùå Failed to install docker-compose"
                exit 1
              fi
            else
              echo "‚úÖ docker-compose is already installed: $(docker-compose --version)"
            fi

            echo "‚úÖ All prerequisites are ready"

            # Create and navigate to app directory with proper permissions
            echo "üìÅ Setting up deployment directory..."
            sudo mkdir -p /opt/trade-give
            sudo chown $USER:$USER /opt/trade-give
            cd /opt/trade-give

            # Clone or pull latest code
            if [ -d ".git" ]; then
              echo "üì• Pulling latest code..."
              git fetch origin
              git reset --hard origin/main
            else
              echo "üì• Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git .
            fi

            # Create .env file if it doesn't exist
            if [ ! -f .env ]; then
              echo "‚ö†Ô∏è  WARNING: No .env file found!"
              echo "üìù Creating default .env - CHANGE THESE VALUES!"
              cat > .env << 'ENV_EOF'
          # Database
          DB_HOST=db
          DB_PORT=3306
          DB_USER=produser
          DB_PASSWORD=CHANGE_ME_SECURE_PASSWORD_123
          DB_NAME=loginapp

          # MySQL
          MYSQL_ROOT_PASSWORD=CHANGE_ME_ROOT_PASSWORD_456
          MYSQL_DATABASE=loginapp
          MYSQL_USER=produser
          MYSQL_PASSWORD=CHANGE_ME_SECURE_PASSWORD_123

          # Backend
          JWT_SECRET=CHANGE_ME_SUPER_SECRET_JWT_KEY_789
          PORT=3000
          NODE_ENV=production
          ENV_EOF
              echo "‚ö†Ô∏è  IMPORTANT: Edit /opt/trade-give/.env and set secure passwords!"
            fi

            # Stop existing containers
            echo "‚èπÔ∏è  Stopping existing containers..."
            docker-compose down || true

            # Build images directly on EC2
            echo "üî® Building Docker images on EC2..."
            docker-compose build --no-cache

            # Start new containers
            echo "‚ñ∂Ô∏è  Starting new containers..."
            docker-compose up -d

            # Wait for services
            echo "‚è≥ Waiting for services to be healthy..."
            sleep 30

            # Check backend health
            if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "‚úÖ Backend is healthy!"
            else
              echo "‚ùå Backend health check failed!"
              docker-compose logs backend
              exit 1
            fi

            # Cleanup old images
            echo "üßπ Cleaning up old images..."
            docker image prune -af --filter "until=72h"

            echo "‚úÖ Deployment completed successfully!"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment..."

          # Check if the API is responding
          if curl -f http://${{ secrets.EC2_HOST }}:3000/api/health > /dev/null 2>&1; then
            echo "‚úÖ Deployment verified successfully!"
            echo "üåê Application is live at: http://${{ secrets.EC2_HOST }}"
          else
            echo "‚ö†Ô∏è  External health check failed, but deployment may still be successful if firewall blocks external access"
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "üöÄ Deployment Summary"
          echo "===================="
          echo "Triggered by: ${{ github.event.workflow_run.event }}"
          echo "Status: ${{ job.status }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: main"
          echo "Tests Result: ${{ github.event.workflow_run.conclusion }}"
          echo "Deployment Method: Build directly on EC2 (no Docker Hub needed)"
          if [ "${{ job.status }}" == "success" ]; then
            echo ""
            echo "‚úÖ Deployment succeeded!"
            echo "üåê Application URL: http://${{ secrets.EC2_HOST }}"
          else
            echo ""
            echo "‚ùå Deployment failed!"
          fi

      - name: Comment on PR (if from PR)
        if: always() && github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ Deployment succeeded!' : '‚ùå Deployment failed!';
            const body = `## AWS Deployment ${status}

            **Commit:** \`${{ github.sha }}\`
            **Method:** Built directly on EC2

            ${status.includes('‚úÖ') ? 'üåê **Application URL:** http://${{ secrets.EC2_HOST }}' : ''}

            **Deployment Method:** SSH + Git Clone + Docker Compose Build

            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key.pem
